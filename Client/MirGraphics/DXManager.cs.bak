using Shared.Unity.Imaging;
using Client.MirControls;
using Client.MirScenes;
using System.Collections.Generic;
using Texture2D = UnityEngine.Texture2D;
using RenderTexture = UnityEngine.RenderTexture;
using ColorUnity = UnityEngine.Color;
using Rect = UnityEngine.Rect;
using Graphics = UnityEngine.Graphics;
using Material = UnityEngine.Material;
using Shader = UnityEngine.Shader;
using Object = UnityEngine.Object;
using Shared.Unity;

namespace Client.MirGraphics
{
    class DXManager
    {
        public static List<MImage> TextureList = new List<MImage>();
        public static List<MirControl> ControlList = new List<MirControl>();

        public static RenderTexture CurrentSurface;
        public static RenderTexture MainSurface;

        public static bool DeviceLost;
        public static float Opacity = 1F;
        public static bool Blending;
        public static float BlendingRate;
        public static BlendMode BlendingMode;

        public static Texture2D RadarTexture;
        public static List<Texture2D> Lights = new List<Texture2D>();
        public static Texture2D PoisonDotBackground;

        public static Dictionary<string, Texture2D> LightTextures = new Dictionary<string, Texture2D>();
        public static Texture2D FloorTexture, LightTexture;
        public static RenderTexture FloorSurface, LightSurface;

        public static bool GrayScale;

        public static Material nowAtlasMaterial, atlasMaterial, defAtlasMaterial, grayscaleMaterial, lightMaterial;

        public static Point[] LightSizes =
        {
            new Point(125,95),
            new Point(205,156),
            new Point(285,217),
            new Point(365,277),
            new Point(445,338),
            new Point(525,399),
            new Point(605,460),
            new Point(685,521),
            new Point(765,581),
            new Point(845,642),
            new Point(925,703)
        };

        public static UnityEngine.Rendering.CommandBuffer clearBuffer;

        public static void Create()
        {
            if (RadarTexture == null)
            {
                RadarTexture = new Texture2D(2, 2,UnityEngine.TextureFormat.ARGB32,false);
            }

            if (PoisonDotBackground == null)
            {
                PoisonDotBackground = new Texture2D(5, 5,UnityEngine.TextureFormat.ARGB32,false);
            }

            nowAtlasMaterial = new Material(Shader.Find("Sprites/Default")); // 默认材质
            nowAtlasMaterial.SetColor("_Color", UnityEngine.Color.white);

            defAtlasMaterial = new Material(Shader.Find("Sprites/Default")); // 默认材质
            defAtlasMaterial.SetColor("_Color", UnityEngine.Color.white);

            atlasMaterial = new Material(Shader.Find("Shader/Light"));// 混合材质
            atlasMaterial.SetColor("_Color", UnityEngine.Color.white);

            grayscaleMaterial = new Material(Shader.Find("Shader/GrayScale")); //灰度材质
            grayscaleMaterial.SetColor("_Color", UnityEngine.Color.white);

            lightMaterial = new Material(Shader.Find("Shader/Light")); // 黑夜光照
            // lightMaterial.SetColor("_Color", UnityEngine.Color.black);

            CreateLights();

            clearBuffer = new UnityEngine.Rendering.CommandBuffer() { name = "Clear Buffer" };
        }

        // 填充纹理数据，实现渐变效果
        private static void FillTextureWithGradient(Texture2D texture, int width, int height)
        {
            UnityEngine.Color[] blendColors = new UnityEngine.Color[]
            {
            UnityEngine.Color.white,
            new UnityEngine.Color(0.82f, 0.82f, 0.82f, 1f),
            new UnityEngine.Color(0.63f, 0.63f, 0.63f, 1f),
            new UnityEngine.Color(0.27f, 0.27f, 0.27f, 1f),
            new UnityEngine.Color(0.16f, 0.16f, 0.16f, 1f),
            new UnityEngine.Color(0f, 0f, 0f, 0f)
            };
            float[] radiusPositions = { 0f, 0.20f, 0.40f, 0.60f, 0.80f, 1.0f };

            // 循环遍历像素
            for (int y = 0; y < height; y++)
            {
                for (int x = 0; x < width; x++)
                {
                    // 计算距离
                    float dist = UnityEngine.Vector2.Distance(new UnityEngine.Vector2(x, y), new UnityEngine.Vector2(width / 2, height / 2)) / (width / 2);
                    dist = UnityEngine.Mathf.Clamp01(dist);

                    // 根据距离插值找到合适的颜色
                    UnityEngine.Color color = UnityEngine.Color.black;
                    for (int j = 1; j < radiusPositions.Length; j++)
                    {
                        if (dist <= radiusPositions[j])
                        {
                            float t = UnityEngine.Mathf.InverseLerp(radiusPositions[j - 1], radiusPositions[j], dist);
                            color = UnityEngine.Color.Lerp(blendColors[j - 1], blendColors[j], t);
                            break;
                        }
                    }

                    texture.SetPixel(x, y, color);
                }
            }

            // 应用像素更改
            texture.Apply();
        }

        private unsafe static void CreateLights()
        {
            // 清理现有光纹理
            for (int i = Lights.Count - 1; i >= 0; i--)
            {
                Object.Destroy(Lights[i]);
            }
            Lights.Clear();

            // 从第二个尺寸开始创建光纹理
            for (int i = 1; i < LightSizes.Length; i++)
            {
                int width = LightSizes[i].X;
                int height = LightSizes[i].Y;

                // 创建空白纹理
                Texture2D light = new Texture2D(width, height, UnityEngine.TextureFormat.ARGB32, false);
                light.wrapMode = UnityEngine.TextureWrapMode.Clamp;
                light.filterMode = UnityEngine.FilterMode.Bilinear;

                // 填充纹理数据，实现渐变效果
                FillTextureWithGradient(light, width, height);

                // 保存纹理
                Lights.Add(light);
            }
        }

        public static void Clear(Color _Color)
        {
            // ColorUnity tmpColor = _Color.ToUnity();
            // clearBuffer.Clear();
            // clearBuffer.ClearRenderTarget(true, true, tmpColor);
            // Graphics.ExecuteCommandBuffer(clearBuffer);

            UnityEngine.GL.Clear(true, true, _Color.ToUnity());
        }

        public static void SetSurface(RenderTexture surface)
        {
            if (CurrentSurface == surface)
                return;

            CurrentSurface = surface;
        }
        public static void SetGrayscale(bool value)
        {
            GrayScale = value;

            if (value == true)
            {
                grayscaleMaterial.EnableKeyword("_GRAYSCALEENABLED_ON");
                nowAtlasMaterial = grayscaleMaterial;
            }
            else
            {
                nowAtlasMaterial = defAtlasMaterial;
            }
        }

        public static void LineDraw(Vector2[] vertices, Color _Color)
        {
            UnityEngine.GL.PushMatrix();
            // 开始绘制线条
            UnityEngine.GL.Begin(UnityEngine.GL.LINES);
            UnityEngine.GL.Color(_Color.ToUnity());
            for (int i = 0; i < vertices.Length; i++)
            {
                UnityEngine.Vector3 tmp1 = new UnityEngine.Vector3(vertices[i].X, vertices[i].Y, 0);
                UnityEngine.GL.Vertex(tmp1);
            }

            UnityEngine.GL.End();

            UnityEngine.GL.PopMatrix();
        }

        public static void DrawOpaque(Texture2D texture, Rectangle? sourceRect, Vector3 position, Color color, float opacity)
        {
            color.A = (byte)(opacity * 255);
            Draw(texture, sourceRect, position, color);
        }

        public static void Draw(Texture2D texture, Rectangle? sourceRect, Vector3 position, Color color)
        {
            if (texture == null)
            {
                return;
            }

            // 纹理大小
            int textureWidth = texture.width;
            int textureHeight = texture.height;

            // 根据 sourceRect 设置绘制区域的宽高
            int drawWidth = sourceRect?.Width ?? textureWidth;
            int drawHeight = sourceRect?.Height ?? textureHeight;

            // 位置
            Rect _position = new Rect(position.X, position.Y, drawWidth, drawHeight);

            // 设置纹理的源矩形 UV 坐标
            Rect _sourceRect = new Rect(0, 0, 1f, 1f);
            if (sourceRect.HasValue)
            {
                // 计算 UV 坐标，将 sourceRect 映射到 0-1 的范围
                _sourceRect.x = (float)sourceRect.Value.X / textureWidth;
                _sourceRect.y = (float)(textureHeight - sourceRect.Value.Y - drawHeight) / textureHeight; // 从左上角开始计算
                _sourceRect.width = (float)drawWidth / textureWidth;
                _sourceRect.height = (float)drawHeight / textureHeight;
            }

            // 颜色
            ColorUnity tmpColor = color.ToUnity();

            // 纹理缝隙填充
            texture.wrapMode = UnityEngine.TextureWrapMode.Clamp;
            texture.filterMode = UnityEngine.FilterMode.Bilinear;

            //强制设置透明度
            if(Opacity > 0 && Opacity < 1)
            {
                tmpColor.a = Opacity;
            }

            // 使用正确的 UV 坐标绘制纹理
            Graphics.DrawTexture(_position, texture, _sourceRect, 0, 0, 0, 0, tmpColor, nowAtlasMaterial);

            CMain.DPSCounter++;
        }

        public static void SetOpacity(float opacity)
        {
            if (Opacity == opacity)
                return;

            nowAtlasMaterial = defAtlasMaterial;
            Opacity = opacity;
        }
        public static void SetBlend(bool value, float rate = 1F, BlendMode mode = BlendMode.NORMAL)
        {
            if (value == Blending && BlendingRate == rate && BlendingMode == mode) return;

            Blending = value;
            BlendingRate = rate;
            BlendingMode = mode;

            if (Blending)
            {
                atlasMaterial.SetInt("_SrcBlend", (int)UnityEngine.Rendering.BlendMode.SrcAlpha);
                atlasMaterial.SetInt("_DstBlend", (int)UnityEngine.Rendering.BlendMode.One);
                atlasMaterial.SetColor("_Color", new ColorUnity(BlendingRate, BlendingRate, BlendingRate, BlendingRate));
                nowAtlasMaterial = atlasMaterial;
            }
            else
                nowAtlasMaterial = defAtlasMaterial;

        }

        public static void SetBlend1(bool value, float rate = 1F, BlendMode mode = BlendMode.NORMAL)
        {
            if (value == Blending && BlendingRate == rate && BlendingMode == mode) return;

            Blending = value;
            BlendingRate = rate;
            BlendingMode = mode;

            if (Blending)
            {
                lightMaterial.SetInt("_SrcBlend", (int)UnityEngine.Rendering.BlendMode.Zero);
                lightMaterial.SetInt("_DstBlend", (int)UnityEngine.Rendering.BlendMode.SrcAlpha);
                lightMaterial.SetColor("_Color", new ColorUnity(BlendingRate, BlendingRate, BlendingRate, BlendingRate));
                nowAtlasMaterial = lightMaterial;
            }
            else
            {
                nowAtlasMaterial = defAtlasMaterial;
            }
        }

        public static void SetRenderState(UnityEngine.Rendering.BlendMode c1, UnityEngine.Rendering.BlendMode c2)
        {
            nowAtlasMaterial.SetInt("_SrcBlend", (int)c1);
            nowAtlasMaterial.SetInt("_DstBlend", (int)c2);
            
        }

        public static void Clean()
        {
            for (int i = TextureList.Count - 1; i >= 0; i--)
            {
                MImage m = TextureList[i];

                if (m == null)
                {
                    TextureList.RemoveAt(i);
                    continue;
                }

                if (CMain.Time <= m.CleanTime) continue;

                m.DisposeTexture();
            }

            for (int i = ControlList.Count - 1; i >= 0; i--)
            {
                MirControl c = ControlList[i];

                if (c == null)
                {
                    ControlList.RemoveAt(i);
                    continue;
                }

                if (CMain.Time <= c.CleanTime) continue;

                c.DisposeTexture();
            }
        }


        private static void CleanUp()
        {
            if (CurrentSurface != null)
            {
                CurrentSurface = null;
            }

            if (PoisonDotBackground != null)
            {
                PoisonDotBackground = null;
            }

            if (RadarTexture != null)
            {
                Object.Destroy(RadarTexture);
                RadarTexture = null;
            }

            if (FloorTexture != null)
            {
                Object.Destroy(FloorTexture);

                DXManager.FloorTexture = null;
                GameScene.Scene.MapControl.FloorValid = false;

                if (DXManager.FloorSurface != null)
                {
                    Object.Destroy(DXManager.FloorSurface);
                }

                DXManager.FloorSurface = null;
            }

            if (LightTexture != null)
            {
                Object.Destroy(LightTexture);

                DXManager.LightTexture = null;

                if (DXManager.LightSurface != null)
                {
                    Object.Destroy(DXManager.LightSurface);
                }

                DXManager.LightSurface = null;
            }

            if (Lights != null)
            {
                for (int i = 0; i < Lights.Count; i++)
                {
                    Object.Destroy(Lights[i]);
                }
                Lights.Clear();
            }

            for (int i = TextureList.Count - 1; i >= 0; i--)
            {
                MImage m = TextureList[i];

                if (m == null) continue;

                m.DisposeTexture();
            }
            TextureList.Clear();


            for (int i = ControlList.Count - 1; i >= 0; i--)
            {
                MirControl c = ControlList[i];

                if (c == null) continue;

                c.DisposeTexture();
            }
            ControlList.Clear();
        }

        // public static void Dispose()
        // {
        //     CleanUp();

        //     Device?.Direct3D?.Dispose();
        //     Device?.Dispose();

        //     NormalPixelShader?.Dispose();
        //     GrayScalePixelShader?.Dispose();
        //     MagicPixelShader?.Dispose();
        // }
    }
}